<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/bootstrap-icons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/vendors.css') }}">

    <title>Almasell calculator</title>
</head>
<body class="has-sidebar">
        <nav class="header | navbar">
        <div class="container flex-nowrap gap-3">
            <div class="header__left">
                <ul class="navbar-nav">
                    
                        <li class="nav-item | d-none d-lg-block">
                            <a href="." class="nav-link"><i class="bi-arrow-left me-2"></i>Volver</a>
                        </li>
                        <li class="nav-item | d-lg-none">
                            <a href="." class="header__action-btn | btn">
                                <i class="btn-icon | bi-arrow-left-short"></i>
                                <span class="header__action-btn-label">Volver</span>
                            </a>
                        </li>
                    
                </ul>
            </div>
            <div class="header__center">
                <a href="." class="navbar-brand">
                    <img src="{{ url_for('static', filename='assets/img/logo.svg') }}" class="logo" alt="">
                </a>
            </div>
            <div class="header__right">
                
                    <button class="header__action-btn | btn d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample" aria-controls="offcanvasExample" aria-label="Toggle navigation">
                        <i class="btn-icon | bi-list"></i>
                        <span class="header__action-btn-label">Ver tarifas</span>
                    </button>
                
            </div>
        </div>
    </nav>

    <main class="main-content py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-10 col-xl-10">
                    <!-- stepper - section -->
                    <section>
                            <!-- stepper - start -->
                            <div class="stepper">
                        <!-- Recepción step -->
                                <div id="reception-step" class="step current">
                                    <button class="step-header js-btn-open" type="button">
                                        <div class="step-header-info me-2">
                                            <span class="step-header-number me-2 me-md-3">
                                                <span class="number">1</span>
                                                <span class="checkmark">
                                                    <i class="bi bi-check2"></i>
                                                </span>
                                            </span>
                                            <div class="row gx-2 align-items-center w-100">
                                                <div class="col-md-3 col-lg-4 col-xl-4">
                                                    <h6 class="step-header-title">Entrada</h6>
                                                </div>
                                                <div class="step-header-summary col-md-9 col-lg-8 col-xl-8">70 productos - 345 unidades</div>
                                            </div>
                                        </div>
                                        <span class="step-header-indicator">Cambiar</span>
                                    </button>

                                    <div role="region" class="collapse show">
                                        <div class="step-content">
                                            <p class="text-muted fs-6 mb-2">Estas cantidades corresponden a lo que llevarás al almacén </p>
                                            
                                            <h6 class="mb-4">Ingresa las cantidades</h6>

                                                <div class="vstack" id="reception-container"></div>

                                            <div class="mt-5">
                                                <button type="button" id="goToStorage" class="btn btn-primary js-btn-next w-100">Continuar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        <!-- Storage step -->
                                <div id="storage-step" class="step disabled">
                                    <button class="step-header js-btn-open" type="button">
                                        <div class="step-header-info me-2">
                                            <span class="step-header-number me-2 me-md-3">
                                                <span class="number">2</span>
                                                <span class="checkmark">
                                                    <i class="bi bi-check2"></i>
                                                </span>
                                            </span>
                                            <div class="row gx-2 align-items-center w-100">
                                                <div class="col-md-3 col-lg-4 col-xl-4">
                                                    <h6 class="step-header-title">Almacenamiento</h6>
                                                </div>
                                                <div class="step-header-summary col-md-9 col-lg-8 col-xl-8">70 productos - 345 unidades</div>
                                            </div>
                                        </div>
                                    </button>

                                    <div role="region" class="collapse">
                                        <div class="step-content">
                                            <div class="mb-4">
                                                <h6 class="mb-2">Confirma las cantidades a almacenar</h6>
                                                <div class="text-body-secondary tx-small-1">Para editar vuelve a Recepción.</div>
                                            </div>
                                    <!-- Read‑only confirmation -->
                                            <div class="vstack" id="storage-container"></div>   

                                            <div class="mt-5">
                                                <button type="button" 
                                                        class="btn btn-primary js-btn-next w-100"
                                                        id="submitReceived">
                                                Continuar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        <!-- Output step -->
                                <div id="output-step" class="step disabled">
                                    <button class="step-header js-btn-open" type="button">
                                        <div class="step-header-info me-2">
                                            <span class="step-header-number me-2 me-md-3">
                                                <span class="number">3</span>
                                                <span class="checkmark">
                                                    <i class="bi bi-check2"></i>
                                                </span>
                                            </span>
                                            <div class="row gx-2 align-items-center w-100">
                                                <div class="col-md-3 col-lg-4 col-xl-4">
                                                    <h6 class="step-header-title">Salida</h6>
                                                </div>
                                                <div class="step-header-summary col-md-9 col-lg-8 col-xl-8"></div>
                                            </div>
                                        </div>
                                        <span class="step-header-indicator">Cambiar</span>
                                    </button>

                                    <div role="region" class="collapse">
                                        <div class="step-content">
                                            <h6 class="mb-3">Elige cómo estimar el costo de tus pedidos</h6>
                                            <div class="hstack gap-3" role="tablist">
                                                <button type="button" class="btn btn-outline-secondary w-100 lh-sm" data-bs-toggle="tab" data-bs-target="#order-simulator-tab-pane" role="tab">Simula un pedido</button>
                                                <button type="button" class="btn btn-outline-secondary w-100 lh-sm" data-bs-toggle="tab" data-bs-target="#monthly-orders-tab-pane" role="tab">Promedio de ventas mensuales</button>
                                            </div>

                                            <div class="mt-4">
                                                <div class="tab-content"                       id="step3-tab-content">
                                                    <div class="tab-pane fade" id="order-simulator-tab-pane" role="tabpanel" tabindex="0">
                                                    </div>
                                              
                                                    
                                                    <div class="tab-pane fade" id="monthly-orders-tab-pane" role="tabpanel" tabindex="0">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

            

                            </div>
                            <!-- stepper - end -->
                    </section>
                    <!-- stepper - section end -->
                </div>
            </div>


        </div>
    </main>

        <aside class="offcanvas-lg offcanvas-end | checkout__aside" tabindex="-1" id="offcanvasExample">
        <div class="hstack justify-content-between p-3">
            <div class="lh-1">
                <h6>Tarifas calculadas</h6>
                <small class="tx-small-2 text-body-tertiary">
                    <span id="productCount">0</span> productos
                </small>
            </div>
            <button type="button" class="btn-close | d-lg-none" data-bs-dismiss="offcanvas" data-bs-target="#offcanvasExample" aria-label="Close"></button>
        </div>
        <ul class="nav-custom nav-custom-sm | nav nav-fill" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="reception-tab" data-bs-toggle="tab" data-bs-target="#reception-tab-pane" type="button" role="tab" aria-controls="reception-tab-pane" aria-selected="true">Entrada</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="storage-tab" data-bs-toggle="tab" data-bs-target="#storage-tab-pane" type="button" role="tab" aria-controls="storage-tab-pane" aria-selected="false">Almacenamiento</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="output-tab" data-bs-toggle="tab" data-bs-target="#output-tab-pane" type="button" role="tab" aria-controls="output-tab-pane" aria-selected="false">Salida</button>
            </li>
        </ul>
        <div class="flex-grow-1 flex-shrink-1 overflow-y-auto nice-scrollbar px-3 mb-0">
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="reception-tab-pane" role="tabpanel" aria-labelledby="reception-tab" tabindex="0">
                    <!-- cart items -->
                    <ul id="sidebar-reception-list" class="list-unstyled vstack" style="flex-basis: 100%">
                        
                        
                    </ul>
                </div>
                <div class="tab-pane fade" id="storage-tab-pane" role="tabpanel" aria-labelledby="storage-tab" tabindex="0">
                    <!-- cart items -->
                    <ul id="sidebar-storage-list" class="list-unstyled vstack" style="flex-basis: 100%">
                        
                    </ul>
                </div>
                <div class="tab-pane fade" id="output-tab-pane" role="tabpanel" aria-labelledby="output-tab" tabindex="0">
                    <!-- cart items -->
                     <div class="tab-content">
                        <div class="tab-pane fade" id="sidebar-order-simulator-tab-pane" role="tabpanel" tabindex="0">
                            <h6 class="py-2">Resultados de simulación de pedido</h6>
                            <ul id="sidebar-sim-list" class="list-unstyled vstack" style="flex-basis: 100%">
                            </ul>
                        </div>
                        <div class="tab-pane fade" id="sidebar-monthly-orders-tab-pane" role="tabpanel" tabindex="0">
                            <h6 class="py-2">Resultados de salidas mensuales</h6>
                            <ul id="sidebar-monthly-list" class="list-unstyled vstack" style="flex-basis: 100%">
                            </ul>
                        </div>
                     </div>
                </div>
            </div>
        </div>

        <!-- cart pricing -->
        <div class="flex-grow-0 flex-shrink-0 p-3 bg-light-secondary">
            <div class="tx-small-1 vstack">
                <div class="d-flex justify-content-between text-body-secondary">
                    <div>Entrada</div><div data-summary="reception">$0.00</div>
                </div>
                <div class="d-flex justify-content-between text-body-secondary">
                    <div>Almacenamiento</div><div data-summary="storage">$0.00</div>
                </div>
                <div class="d-flex justify-content-between text-body-secondary">
                    <div>Salida</div><div data-summary="output">$0.00</div>
                </div>
                <div class="d-flex justify-content-between">
                    <div class="fw-semibold">Total</div><div data-summary="total" class="text-body fw-semibold">$0.00</div>
                </div>
            </div>
            <div class="d-grid mt-3">
                <!-- <div data-bs-toggle="tooltip" title="Debes completar todos los pasos para generar el resumen."> -->
                    <a href="{{ url_for('calculator.summary') }}" id="finishBtn" class="btn btn-primary w-100 ">Ver resumen</a>
                </div>
            </div>
        </div>
    </aside>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
        //───────────────────────────────────────────
        // STATE + ELEMENT REFS
        //───────────────────────────────────────────
        const BASE_URL = "{{ url_for('calculator.index') }}".replace(/\/$/, '');

        let storagePayload = [];

        const sidebarReceptionList    = document.getElementById('sidebar-reception-list');
        const sidebarStorageList    = document.getElementById('sidebar-storage-list');
        const sidebarSimulatorList    = document.getElementById('sidebar-sim-list');
        const sidebarMonthlyList    = document.getElementById('sidebar-monthly-list');

        const summaryRec   = document.querySelector('[data-summary="reception"]');
        const summaryStr   = document.querySelector('[data-summary="storage"]');
        const summaryOut   = document.querySelector('[data-summary="output"]');
        const summaryTotal = document.querySelector('[data-summary="total"]');

        const simPane     = document.getElementById('order-simulator-tab-pane');
        const monthlyPane = document.getElementById('monthly-orders-tab-pane');

    
        const btnSimulate  = document.querySelector('button[data-bs-target="#order-simulator-tab-pane"]');
        const btnMonthly   = document.querySelector('button[data-bs-target="#monthly-orders-tab-pane"]');

        const receptionContainer = document.getElementById('reception-container');
        const storageContainer = document.getElementById('storage-container');

        function updateSummaryDisplays(totalUnitsReceived, productCountFromSource = null) {
            const productCount = productCountFromSource !== null ? productCountFromSource : (window.storagePayload ? window.storagePayload.length : 0);

            // Select all elements that have the class 'step-header-summary'
            const summaryElements = document.querySelectorAll('.step-header-summary');

            // Iterate over the selected elements, but only up to a maximum of 2.
            // This ensures that the third (and any subsequent) element is skipped.
            for (let i = 0; i < Math.min(summaryElements.length, 2); i++) {
                const element = summaryElements[i];
                element.textContent = `${productCount} productos - ${totalUnitsReceived} unidades`;
            }
            // The third element with this class (if it exists) will simply be skipped by this loop,
            // leaving its content as is.
        }


        function updateProductCount(productCatalog) {
            const productCountElement = document.getElementById('productCount');
            let productCount = 0;

            try {
                // Check if it's actually an array and get its length
                if (Array.isArray(productCatalog)) {
                    productCount = productCatalog.length;
                } else {
                    console.warn("currentProductCatalog in sessionStorage is not an array.");
                }

            } catch (error) {
                console.error("Error parsing currentProductCatalog from sessionStorage:", error);
            }

            // Update the text content of the span
            if (productCountElement) {
                productCountElement.textContent = productCount;
            }
        }

        const parseList = container => {
            console.log('parseList on', container.id, 'with', container.children.length, 'items');
            return Array.from(container.children).map(li => {
            const valueEl = li.querySelector('.reception-value');
            if (valueEl) {
                return {
                type:  'reception_type',
                label: li.querySelector('.fw-semibold')?.textContent.trim() || '',
                value: valueEl.textContent.trim()
                };
            }
            // product row
            return {
                type:     'product',
                label:    li.querySelector('.fw-semibold')?.textContent.trim() || '',
                subtitle: li.querySelector('small.text-body-secondary')?.textContent.trim() || '',
                fee:      li.querySelector('.flex-shrink-0.text-nowrap.fw-semibold')?.textContent.trim() || ''
            };
        });
        };

        function renderSidebarSimulator(data) {
            sidebarSimulatorList.innerHTML = '';

            data.order_products_details.forEach(item => sidebarSimulatorList.insertAdjacentHTML('beforeend', `
            <li class="checkout-product d-flex tx-small-1 gap-3 py-2">
                <div class="flex-grow-1">
                <div class="fw-semibold">${item.product_name}</div>
                <small class="text-body-secondary">${item.quantity_ordered} unidades</small>
                </div>
            </li>
            `));
            summaryOut.textContent = `$${data.total_order_cost.toFixed(2)}`;
            updateTotal();
            // toggleOutputSidebar(true);
        }

        // NOT FUNCTIONING
        // THIS MUST BE SYNCHRONIZED WITH WHAT THE BACKEND RETURNS UPON THE USER INPUT IN 
        // THE PANE THAT THE FUNCTION renderMonthly(items) SHOULD RENDER
        function renderSidebarMonthly(data) {
            sidebarMonthlyList.innerHTML = '';
            data.sales_products_details.forEach(item => sidebarMonthlyList.insertAdjacentHTML('beforeend', `
            <li class="checkout-product d-flex tx-small-1 gap-3 py-2">
                <div class="flex-grow-1">
                <div class="fw-semibold">${item.product_name}</div>
                <small class="text-body-secondary">${item.simulated_quantity_sold} pedidos –  1 unidad c/u</small>
                </div>
                <div class="flex-shrink-0 text-nowrap fw-semibold">$${item.total_orders_cost_per_product.toFixed(2)}</div>
            </li>
            `));
            summaryOut.textContent = `$${data.total_monthly_cost.toFixed(2)}`;
            updateTotal();
            // toggleOutputSidebar(false);
        }
        // FUNCTIONING
        function updateTotal() {
            const r = parseFloat(summaryRec.textContent.slice(1))||0;
            const s = parseFloat(summaryStr.textContent.slice(1))||0;
            const o = parseFloat(summaryOut.textContent.slice(1))||0;
            summaryTotal.textContent = `$${(r+s+o).toFixed(2)}`;
        }


  // Helper: POST simulator payload and update sidebar
        function submitSimulator() {
            const payload = Array.from(
                simPane.querySelectorAll('[data-product-id]'))
                .map(el => {
                    const product_id = el.dataset.productId;
                    const quantity_ordered = +el.querySelector('input').value;

                    if (!product_id) {
                        console.warn("Checkout.html: submitSimulator - Missing product ID for order element. Skipping item:", el);
                        return null; // Return null to be filtered out later
                    }
                    return {
                        product_id: product_id, // Send as string UUID
                        quantity_ordered: quantity_ordered
                    };
                })
                .filter(item => item !== null); // Filter out any items where product_id was missing

            fetch(`${BASE_URL}/simulate-order`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ order_items: payload })
            })
            .then(r => {
                // Check if response is OK (2xx status)
                if (!r.ok) {
                    // Try to get error details from the response body, even if it's not JSON
                    return r.text().then(text => {
                        throw new Error(`HTTP error! Status: ${r.status}, Message: ${text}`);
                    });
                }
                // If OK, parse as JSON
                return r.json();
            })
            .then(json => {
                console.log("Checkout.html: Response from /simulate-order:", json);
                renderSidebarSimulator(json);
            })
            .catch(error => {
                // This catch now handles both network errors and JSON parsing errors
                console.error('Checkout.html: Error during /simulate-order fetch operation:', error);
                // Provide user feedback (e.g., a modal or status message)
                // alert(`Failed to update inventory costs: ${error.message}. Please check console for details.`);
            });
            
    
        }


        // Helper: POST monthly payload and update sidebar
        function submitMonthly() {
            const payload = Array.from(monthlyPane.querySelectorAll('[data-product-id]'))
                .map(el => ({
                product_id: el.dataset.productId,
                sales_percentage: +el.querySelector('.form-range').value
                }));
            fetch(`${BASE_URL}/simulate-monthly-sales`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ sales_percentages: payload })
            })
            .then(r => r.json())
            .then(renderSidebarMonthly);
        }


        // FUNCTIONAL
        function initQuantityControls(rootElement) {
            const targetElement = rootElement || document;
            const quantityInputs = document.querySelectorAll('.quantity-input');

            quantityInputs.forEach((container) => {
                const input = container.querySelector('.quantity-input__input'); // The input field
                const btnDecrease = container.querySelector('.quantity-input__btn:first-child'); // Decrease button
                const btnIncrease = container.querySelector('.quantity-input__btn:last-child'); // Increase button


                if (!input || !btnDecrease || !btnIncrease) {
                    console.warn('Missing elements in quantity-input container:', container);
                    return; // Skip this container if elements are not found
                }

                // Function to update button states
                const updateButtonStates = () => {
                    const currentValue = parseInt(input.value, 10) || 0; // Get current value or default to 0
                    const maxValue = parseInt(input.max, 10); // Get max value if defined
                    const minValue = parseInt(input.min, 10) || 0; // Get min value or default to 0

                    btnDecrease.disabled = currentValue <= minValue;

                    btnIncrease.disabled = maxValue && currentValue >= maxValue;
                };

                // Decrease button functionality
                btnDecrease.addEventListener('click', () => {
                    const currentValue = parseInt(input.value, 10) || 0;
                    const minValue = parseInt(input.min, 10) || 0;
                    if (currentValue > minValue) {
                        input.value = currentValue - 1;
                        updateButtonStates(); // Update button states after value change
                    // Trigger input event for external listeners (e.g., recalc)
                    }
                });

                // Increase button functionality
                btnIncrease.addEventListener('click', () => {
                    const currentValue = parseInt(input.value, 10) || 0;
                    const maxValue = parseInt(input.max, 10);
                    // If maxValue is not set (NaN) or current value is less than max
                    if (isNaN(maxValue) || currentValue < maxValue) {
                        // Increase value, ensuring it doesn't exceed maxValue if it's defined
                        input.value = isNaN(maxValue) ? currentValue + 1 : Math.min(currentValue + 1, maxValue);
                        updateButtonStates(); // Update button states after value change
                        input.dispatchEvent(new Event('input')); // Trigger input event for external listeners (e.g., recalc)
                    }
                });
                // Ensure the value is within bounds when entered manually
                input.addEventListener('input', () => {
                    let currentValue = parseInt(input.value, 10);
                    const minValue = parseInt(input.min, 10) || 0;
                    const maxValue = parseInt(input.max, 10);

                    if (isNaN(currentValue)) {
                        input.value = minValue; // Set to min if input is not a number
                    } else if (currentValue < minValue) {
                        input.value = minValue; // Clamp to min if below
                    } else if (maxValue && currentValue > maxValue) {
                        input.value = maxValue; // Clamp to max if above and max is defined
                    }
                    updateButtonStates(); 
                });
                updateButtonStates();
            });
        }


        function bindOutputEvents() {
        

            // --- Simulator: live-submit on quantity change (± buttons or manual) ---
            simPane.querySelectorAll('.quantity-input__input').forEach(input => {
                input.addEventListener('input', submitSimulator);
            });
            simPane.querySelectorAll('.quantity-input__btn').forEach(btn => {
                btn.addEventListener('click', () => {
                // wait a tick for the value to update
                setTimeout(submitSimulator, 0);
                });
            });

            // --- Monthly: general slider mirrors + submit ---
            const genSlider = monthlyPane.querySelector('#general-percentage-range');
            let genLabel = null; // Initialize to null

            if (genSlider) {
                if (genSlider.previousElementSibling) {
                    genLabel = genSlider.previousElementSibling.querySelector('b');
                }
                
                genSlider.addEventListener('input', () => {
                    const pct = genSlider.value;
                    const text = pct + '%';
                    if (genLabel) { // Now safely check if genLabel was found
                        genLabel.textContent = text;
                    }
                monthlyPane.querySelectorAll('[data-product-id]').forEach(row => {
                    const s = row.querySelector('.form-range');
                    // Robust check for individual product sliders
                    let l = null;
                    if (s && s.previousElementSibling) {
                        l = s.previousElementSibling.querySelector('b');
                    }
                    if (s && l) {
                        s.value = pct;
                        l.textContent = text;
                    }
                });
                submitMonthly();
            });
        }

            monthlyPane.querySelectorAll('.form-range').forEach(slider => {
                // Robust check for all form-range sliders
                let labelB = null;
                if (slider && slider.previousElementSibling) {
                    labelB = slider.previousElementSibling.querySelector('b');
                }

                if (labelB) { // Only add listener if the label is found
                    slider.addEventListener('input', () => {
                        labelB.textContent = slider.value + '%';
                        submitMonthly();
                    });
                }
            });

        

            const resetBtn = document.getElementById('resetOrderEstimation');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    const inputs = simPane.querySelectorAll('.quantity-input__input');
                    inputs.forEach(input => {
                        input.value = 0;
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                    });
                });
            }
        }

            
      


        function renderSimulator(items) {
            // Header + reset button
            simPane.innerHTML = `
            <div class="hstack justify-content-between gap-3 mb-3">
                <div class="text-body-secondary">
                <strong>Ingrese las unidades de cada producto para simular su pedido</strong>
                </div>
                <button id="resetOrderEstimation"
                        type="button"
                        class="btn btn-light btn-sm text-nowrap">
                Reiniciar <i class="bi bi-arrow-counterclockwise"></i>
                </button>
            </div>
            ${items.map(item => `
                <div class="hstack justify-content-between gap-2 border-top py-2"
                    data-product-id="${item.product_id}">
                    <div class="fw-semibold tx-small-1 lh-sm flex-grow-1">
                        ${item.product_name}
                    </div>
                    <div class="flex-shrink-0 hstack gap-3">
                        <div class="form-label mb-0 d-none d-md-block">Unidades:</div>
                        <div class="quantity-input">
                        
                        <button class="quantity-input__btn | btn" type="button">
                        <i class="bi-dash-lg"></i></button>
                        <input type="number"
                            class="quantity-input__input form-control"
                            inputmode="numeric"
                            value="0"
                            min="0"
                            title="Cantidad"
                            autocomplete="off"
                            >
                        <button class="quantity-input__btn | btn" type="button"><i class="bi-plus-lg"></i>
                        </button>
                        </div>
                    </div>
                </div>

            `).join('')}
            `;
            initQuantityControls(simPane);
            bindOutputEvents();
        }

        function renderMonthly(items) {
            // Default general = 0 (or pull from API if available)
            const defaultPct = 0;
            monthlyPane.innerHTML = `
                <div class="mb-4">

                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        <h6 class="alert-heading d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-2"></i> ¿Qué es esto?
                        </h6>
                        <hr>
                        <p class="mb-0">
                            Aquí vamos a suponer que cada venta contiene solo una (1) unidad
                        </p>
                        <p class="mb-0">
                            El porcentaje de venta que elijas para cada producto tendrá como base las cantidades que ingresaste en Entrada
                        </p>
                        <ul>
                            <li>
                                <strong>Ejemplo:</strong> <br>
                                Si ingresaste 50 televisores en la Entrada <br>
                                Y tu porcentaje de venta de los televisores es de 50% <br>
                                Te mostraremos el costo de 25 pedidos donde cada pedido contiene 1 televisor
                            </li>
                        </ul>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>

                <h6 class="mb-3">Porcentaje de ventas general</h6>
                <div>
                <label class="form-label"><b>${defaultPct}%</b></label>
                <input type="range"
                        class="form-range"
                        id="general-percentage-range"
                        value="${defaultPct}"
                        min="0" max="100" step="5">
                </div>
            </div>
            <h6 class="mb-3">Porcentaje de venta por producto</h6>
            <div class="vstack">
                ${items.map(item => `
                <div class="row border-top py-2"
                    data-product-id="${item.product_id}">
                    <div class="col-sm-6 fw-semibold lh-sm flex-grow-1">
                    ${item.product_name}
                    </div>
                    <div class="col-sm-6">
                    <label class="form-label"><b>${defaultPct}%</b></label>
                    <input type="range"
                            class="form-range"
                            value="${defaultPct}"
                            min="0" max="100" step="5">
                    </div>
                </div>
                `).join('')}
            </div>
            `;
            bindOutputEvents();
        }

  
        btnSimulate?.addEventListener('click', () => {
            if (!storagePayload.length) return console.warn('No data in storagePayload');
            renderSimulator(storagePayload);
            
            toggleOutputSidebar(true);
            new bootstrap.Tab(btnSimulate).show();


        });

  
        btnMonthly?.addEventListener('click', () => {
            if (!storagePayload.length) return console.warn('No data in storagePayload');
         
            
            renderMonthly(storagePayload);
            toggleOutputSidebar(false);
            new bootstrap.Tab(btnMonthly).show();
        });

        function toggleOutputSidebar(showSimulator) {
            // both <ul> were already grabbed above
            const simPane   = sidebarSimulatorList.closest('.tab-pane');
            const monPane   = sidebarMonthlyList.closest('.tab-pane');

            // clear old data
            sidebarSimulatorList.innerHTML = '';
            sidebarMonthlyList.innerHTML   = '';

            if (showSimulator) {
                simPane.classList.add('show', 'active');
                monPane.classList.remove('show', 'active');
            } else {
                simPane.classList.remove('show', 'active');
                monPane.classList.add('show', 'active');
            }
        }





   
        

        // FUNCTIONAL
        // THIS SENDS THE INPUT OF RECEPTION STEP TO THE BACKEND
        let recalcTimer = null;
        function scheduleInventoryRecalc() {
            clearTimeout(recalcTimer);
            recalcTimer = setTimeout(() => {
                const itemsToSend = Array.from(
                    receptionContainer.querySelectorAll('[data-product-id]')
                ).map(el => {
                    const productId = el.dataset.productId; // CORRECT: Get UUID as string, no '+'
                    const quantity = +el.querySelector('input').value; // Quantity is a number, so '+' is fine

                    if (!productId) {
                        console.warn("Checkout.html: scheduleInventoryRecalc - Missing product ID for reception element. Skipping item:", el);
                        return null;
                    }
                    return {
                        product_id: productId, // Send as string UUID
                        quantity_received: quantity
                    };
                }).filter(item => item !== null); // Filter out any items where product_id was missing

                if (itemsToSend.length === 0) {
                    console.warn("Checkout.html: No valid reception items to send. Updating sidebar with zeros.");
                    renderSidebarInventory({ received_products_details: [], total_inbound_cost: 0, total_storage_cost: 0 });
                    renderStorageUI([]);
                    return;
                }

                fetch(`${BASE_URL}/calculate-inventory-costs`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ quantities: itemsToSend }) 
                })
                .then(r => {
                    // Check if response is OK (2xx status)
                    if (!r.ok) {
                        // Try to get error details from the response body, even if it's not JSON
                        return r.text().then(text => {
                            throw new Error(`HTTP error! Status: ${r.status}, Message: ${text}`);
                        });
                    }
                    // If OK, parse as JSON
                    return r.json();
                })
                .then(json => {
                    console.log("Checkout.html: Response from /calculate-inventory-costs:", json);
                    renderSidebarInventory(json);
                    renderStorageUI(json.received_products_details);
                    updateSummaryDisplays(json.total_quantity_received, storagePayload.length)
                })
                .catch(error => {
                    // This catch now handles both network errors and JSON parsing errors
                    console.error('Checkout.html: Error during /calculate-inventory-costs fetch operation:', error);
                    // Provide user feedback (e.g., a modal or status message)
                    // alert(`Failed to update inventory costs: ${error.message}. Please check console for details.`);
                });
            }, 200);
        }



    // THIS IS THE FIRST THING THAT IS RENDERED, EXTRACTED FROM MEMORY
        const storedCatalog = sessionStorage.getItem('currentProductCatalog');
        if (storedCatalog) {
            try {
                const productsData = JSON.parse(storedCatalog);
                
                // --- IMPORTANT: Add checks if the stored data is valid ---
                if (!Array.isArray(productsData) || productsData.length === 0) {
                    console.error('Stored product catalog is empty or invalid. User likely arrived directly or session expired.');
                    receptionContainer.innerHTML = '<p class="text-danger">No products found. Please return to the product entry page.</p>';
                    // Optionally redirect the user back to index.html if no data
                    // window.location.href = 'index.html';
                    return; // Stop execution if no valid data
                }

                storagePayload = productsData;
                updateSummaryDisplays(0, productsData.length)
                updateProductCount(productsData)


                // Populate the reception container with the retrieved data
                // (The mapping logic is essentially the same as before, but now uses productsData)
                const receptionContainer = document.getElementById('reception-container');
                // 1) Clear out any old HTML
                receptionContainer.innerHTML = '';

                // 2) Force it to be a column-flex container
                receptionContainer.style.display       = 'flex';
                receptionContainer.style.flexDirection = 'column';
                receptionContainer.style.rowGap        = '1rem';   // same as Bootstrap’s gap-3 (~1rem)

                // 3) For each product, create a flex-row DIV and append it
                productsData.forEach(item => {
                const row = document.createElement('div');
                row.className = 'hstack justify-content-between gap-2 border-top py-2';
                row.dataset.productId = item.product_id;

                // populate the inner HTML exactly as you had it:
                row.innerHTML = `
                    <div class="fw-semibold tx-small-1 lh-sm flex-grow-1">
                    ${item.product_name}
                    </div>
                    <div class="flex-shrink-0 hstack gap-3">
                    <div class="form-label mb-0 d-none d-md-block">Unidades:</div>
                    <div class="quantity-input">
                        <button class="quantity-input__btn btn" type="button">
                        <i class="bi-dash-lg"></i>
                        </button>
                        <input
                        type="number"
                        class="quantity-input__input form-control"
                        inputmode="numeric"
                        value="0"
                        min="0"
                        title="Cantidad"
                        autocomplete="off"
                        >
                        <button class="quantity-input__btn btn" type="button">
                        <i class="bi-plus-lg"></i>
                        </button>
                    </div>
                    </div>
                `;

                receptionContainer.appendChild(row);
                });

                // Initialize quantity controls for the newly rendered elements
                initQuantityControls(receptionContainer);

                // Attach input event listener for recalculation to reception inputs
                receptionContainer.querySelectorAll('.quantity-input__input').forEach(input => {
                    input.addEventListener('input', scheduleInventoryRecalc);
                });
                // Initial call to scheduleInventoryRecalc if you want immediate calculation/sidebar update
                // (Only if there are actual products to send)
                // if (productsData.length > 0) {
                //     scheduleInventoryRecalc();
                // }

            } catch (e) {
                console.error('Error parsing stored product catalog from sessionStorage:', e);
                receptionContainer.innerHTML = '<p class="text-danger">Error loading product data. Please try again.</p>';
                // window.location.href = 'index.html'; // Redirect on parse error
            }
        } else {
            // Handle case where sessionStorage is empty (e.g., first visit to checkout, or tab was closed)
            console.warn('No product catalog found in sessionStorage. User likely arrived directly or session expired.');
            receptionContainer.innerHTML = '<p class="text-warning">No product data found. Please go back to the product entry page to add products.</p>';
            // window.location.href = 'index.html'; // Force user back to input page
        }


        //───────────────────────────────────────────
        // STORAGE‑STEP UI (READ‑ONLY)
        //───────────────────────────────────────────


        // FUNCTIONING
        function renderStorageUI(items) {
            if (!items || items.length === 0) {
                storageContainer.innerHTML = '<p class="text-muted">No items received for storage.</p>';
                return;
            }


            storageContainer.innerHTML = items.map(item => {
                const { product, quantity_received } = item;
                return `
                <div class="hstack justify-content-between gap-2 border-top py-2"
                    data-product-id="${product.product_id}">
                    <div class="fw-semibold">
                    ${product.product_name}
                    </div>
                    <div><b>${quantity_received}</b></div>
                </div>
                `;
                }).join('');
        }


        //───────────────────────────────────────────
        // SIDEBAR RENDERERS
        //───────────────────────────────────────────

        // FUCTIONING
        function renderSidebarInventory(data) {
            sidebarReceptionList.innerHTML = sidebarStorageList.innerHTML = '';

            if (data.in_size_text) {
                sidebarReceptionList.insertAdjacentHTML('beforeend', `
                    <li class="list-group-item d-flex align-items-center justify-content-between tx-small-1 py-2 reception-type-item">
                        <div class="fw-semibold">Tipo de entrada:</div>
                        <div class="text-body-secondary reception-value">${data.in_size_text}</div>
                    </li>
                `);
            }
                        
            data.received_products_details.forEach(item => {
                const { product, quantity_received, total_inbound_fee, total_storage_fee } = item;
                
            sidebarReceptionList.insertAdjacentHTML('beforeend', `
                <li class="checkout-product d-flex tx-small-1 gap-3 py-2">
                <div class="flex-grow-1">
                    <div class="fw-semibold">${product.product_name}</div>
                    <small class="text-body-secondary">${quantity_received} unidades</small>
                </div>
                <div class="flex-shrink-0 text-nowrap fw-semibold">$${total_inbound_fee.toFixed(2)}</div>
                </li>
            `);
            sidebarStorageList.insertAdjacentHTML('beforeend', `
                <li class="checkout-product d-flex tx-small-1 gap-3 py-2">
                <div class="flex-grow-1">
                    <div class="fw-semibold">${product.product_name}</div>
                    <small class="text-body-secondary">${quantity_received} unidades</small>
                </div>
                <div class="flex-shrink-0 text-nowrap fw-semibold">$${item.total_storage_fee.toFixed(2)} /mes</div>
                </li>
            `);
            });
            summaryRec.textContent = `$${data.total_inbound_cost.toFixed(2)}`;
            summaryStr.textContent = `$${data.total_storage_cost.toFixed(2)}`;
            updateTotal();
        }

      

        const finishBtn = document.getElementById('finishBtn');
        finishBtn.addEventListener('click', e => {
            e.preventDefault();

        

            const receptionData = parseList(document.getElementById('sidebar-reception-list'));
            const storageData   = parseList(document.getElementById('sidebar-storage-list'));

            // Determine which output pane is active
            const isSimActive = document.getElementById('sidebar-order-simulator-tab-pane').classList.contains('show');
            const outputContainer = isSimActive
                ? document.getElementById('sidebar-sim-list')
                : document.getElementById('sidebar-monthly-list');
            const outputData = parseList(outputContainer);
            const outputType = isSimActive ? 'simulator' : 'monthly';

            // 2. Read summary numbers
            const summaryRec   = document.querySelector('[data-summary="reception"]').textContent;
            const summaryStr   = document.querySelector('[data-summary="storage"]').textContent;
            const summaryOut   = document.querySelector('[data-summary="output"]').textContent;
            const summaryTotal = document.querySelector('[data-summary="total"]').textContent;

            // 3. Bundle into one object
            const summaryPayload = {
                reception: receptionData,
                storage: storageData,
                output: {
                type: outputType,
                items: outputData
                },
                summary: { r: summaryRec, s: summaryStr, o: summaryOut, total: summaryTotal }
            };

            // 4. Store in sessionStorage and navigate
            sessionStorage.setItem('summaryData', JSON.stringify(summaryPayload));
            window.location.href = `${BASE_URL}/summary`;
        });
    
      

    });
</script>



<!-- EVERYTHING BELOW THIS POINT IS FUNCTIONAL -->
    
<script src="{{ url_for('static', filename='assets/js/plugins/bootstrap.bundle.min.js') }}"></script>
<script src="{{ url_for('static', filename='assets/js/plugins/swiper-bundle.min.js') }}"></script>
<script src="{{ url_for('static', filename='assets/js/main.js') }}"></script>

    <!-- stepper -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const steps   = Array.from(document.querySelectorAll('.step'));
    const btnNext = document.querySelectorAll('.js-btn-next');
    const btnOpen = Array.from(document.querySelectorAll('.js-btn-open'));
    const receptionTab = document.querySelector('#reception-tab');
    const storageTab   = document.querySelector('#storage-tab');
    const outputTab    = document.querySelector('#output-tab');

    function scrollToStep(el) {
      const offset = (72 + 16);
      const pos = el.getBoundingClientRect().top + window.scrollY - offset;
      window.scrollTo({ top: pos, behavior: 'smooth' });
    }

    function activateSidebarTab(id) {
      let tabEl;
      if (id === 'reception-step') tabEl = receptionTab;
      if (id === 'storage-step')   tabEl = storageTab;
      if (id === 'output-step')    tabEl = outputTab;
      if (tabEl) new bootstrap.Tab(tabEl).show();
    }

    function nextStep() {
      const active = document.querySelector('.step.current');
      const idx    = steps.indexOf(active);
      const currCollapse = active.querySelector('.collapse');
      if (currCollapse) {
        active.classList.replace('current','success');
        new bootstrap.Collapse(currCollapse, { show: false });
      }
      const next = steps[idx + 1];
      if (next) {
        const nextCollapse = next.querySelector('.collapse');
        if (nextCollapse) {
          new bootstrap.Collapse(nextCollapse, { show: true });
          next.classList.replace('disabled','current');
          activateSidebarTab(next.id);
          setTimeout(() => scrollToStep(next), 350);
        }
      }
    }

    function toStep(targetIdx) {
      const active   = document.querySelector('.step.current');
      const lastIdx  = steps.indexOf(active);
      if (targetIdx === lastIdx) return; // do nothing if same
      const target = steps[targetIdx];
      if (!target || targetIdx > lastIdx) return; // prevent forward jumps
      // close current
      const currCol = active.querySelector('.collapse');
      if (currCol) new bootstrap.Collapse(currCol, { show: false });
      active.classList.remove('current','success');
      // open target
      const tgtCol = target.querySelector('.collapse');
      if (tgtCol) new bootstrap.Collapse(tgtCol, { show: true });
      target.classList.remove('disabled');
      target.classList.add('current');
      activateSidebarTab(target.id);
      setTimeout(() => scrollToStep(target), 400);
      // disable after
      steps.forEach((el, i) => {
        if (i > targetIdx) {
          el.classList.remove('success');
          el.classList.add('disabled');
        }
      });
    }

    btnNext.forEach(b => b.addEventListener('click', nextStep));
    btnOpen.forEach(b => b.addEventListener('click', () => {
      const idx = steps.indexOf(b.closest('.step'));
      toStep(idx);
    }));
  });
</script>



</body>
</html>